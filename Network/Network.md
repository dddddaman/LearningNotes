## 1、计算机网络分层



计算机网络中会把网络结构分层，目前主要有2种

* 7层 （osi国际标准组织定制）
* 4层（tcp/ip标准，美国军方制定）

#### 7层：物链网输会使用

1. 应用层：用户交互。协议：FTP（文件传输协议），SMTP（电子邮件传输协议），HTTP（超文本传输协议）
2. 表示层：数据处理（加密，格式转换，压缩和恢复），人类语言变成机器语言。协议：ASCII码       
3. 会话层：建立连接，添加校验点，在链接失效时重新连接同步数据（大文件传输）。协议：ADSP，ASP
4. 传输层：端到端通讯，两个主机的进程之间的数据传输和通讯（可靠传输，不可靠传输）。协议：TCP（可靠传输，3次握手保证建立连接，双工通讯（双方同时发送和接受数据），利用缓存保证数据完整有序，添加了序号和确认号验证数据完整性（比如3次握手演示中中经常出现的的seq和ack），电子邮件一类的一般使用这个，保证可靠性，不用太在意即时性），UDP（不可靠传输，一直发送，没有流量控制（有多少发多少），不纠错，一般视频会议一类的使用这个，保证数据速度和即时性，偶尔掉帧什么的无所谓）
5. 网络层： 选择最佳路径，控制发送端流量，纠错（保证传输层数据正确），阻塞控制（控制整体流量）。协议：IP
6. 数据链路层：数据组装成帧（把一个大数据分成一个一个的数据帧101010101010011。。。方便物理层传输）
7. 物理层：物理媒体上数据比特流的透明传输 （把 0 1 数据帧变成高低电压信号传输出去）。协议：IEEE802.4，Rj24

#### 4层：接网输用

1. 应用层：7层中的应用层，表示层，会话层。
   - FTP：文件传输协议
   - SMTP：电子邮件传输协议
   - HTTP：超文本传输协议
2. 传输层：7层中的传输层。
   - TCP：传输控制协议
   - UDP：用户数据报协议
3. 网络层：7层中的网络层。
   - IP：网际协议
   - ICMP：Internet互联网控制报文协议
   - IGMP：Internet组管理协议
4. 链路层（数据链路层、网络接口层）：7层中的数据链路层、物理层。
   - Ethernet：以太网协议，现在大部分局域网都是这种，无连接（没有三次握手），不可靠（没有数据帧号，丢了不知道）
   - ATM：异步传输模式（信元传输）
   - Frame Relay：帧中继（数据帧传输，已经过时了）

## 2、TCP三次握手和四次挥手

TCP是面向连接的协议。运输连接是用来传送TCP报文的。TCP的运输连接有三个过程，即建立连接、数据传输和连接释放。

TCP连接建立过程中要解决以下三个问题

* 要使每一方都能够确认对方的存在
* 要允许双方协商一些参数
* 能够对运输实体资源进行分配

TCP连接的建立采用客户机／服务器模式，主动发起连接建立的应用进程叫做客户机，而被动等待连接建立的应用进程叫做服务器。

#### TCP连接的建立过程

[picture1]
<img src="D:\workkkkkkkk\资料\LearningNotes-master\Network\三次握手.png" style="zoom:80%;" />

－客户机：服务器，我想要和你建立连接，你同意吗？（SYN＝１）

－服务器：客户机，我同意和你建立连接（ACK＝１）；我也想和你建立连接，你同意吗？（SYN＝１）

－客户机：服务器，我同意和你建立连接。（ACK＝１）

其实，在进行第二次握手时（即服务器向客户机进行应答时），可以看作时发了两次包，先回答客户机的服务请求（ACK＝１，ask＝x+１），然后再向客户机发出请求（SYN＝１，seq＝ｙ）



#### TCP连接的释放过程

[picture2]
<img src="D:\workkkkkkkk\资料\LearningNotes-master\Network\四次挥手.png" style="zoom:80%;" />

-客户机：服务器，我想和你断开连接，你同意吗？（FIN=1）

-服务器：我同意（ACK=1）

（在此期间，服务器可能还会向客户机发送数据，但是客户机却不能再向服务器发送数据）

-服务器：客户机，我想要和你断开连接，你同意吗？（FIN=1）

-客户机：我同意。（ACK=1）

再等待2MSL时间后就真正断开了连接。



#### 常见问题：

**1、三次握手中，为什么客户机最后还要再向服务器发送一次确认呢？**

答：这是为了防止已失效的连接请求报文段突然又传到了服务器。

所谓“已失效的连接请求报文段”是这样产生的。考虑一种正常的情况，客户机发出连接请求，但因为连接请求报文丢失而未收到确认。于是客户机再重传了一次连接请求，后来收到了确认，建立了连接。数据传输完后，就释放了连接。客户机共发送了两个连接请求报文段，其中第一个丢失，第二个到达了服务器，没有所谓的“已失效的连接请求报文段”。

但是如果出现了一种异常情况，即客户机发出的第一个报文段并没有丢失，而是在某个节点上长时间滞留了，直至客户机向服务器发送了第二个报文段并且已经完成数据传输释放了连接，此时，第一个报文到达服务器后会被误以为是客户机重新发起的一次连接请求，实质上是一个早已失效的连接请求。如果没有第三次握手，那么这个连接就建立了，但是客户机并不会向服务器发送任何请求，这样连接就会一直持续，白白的消耗网络资源。

**2、为什么客户机发送完最后一个数据后要在TIME-WAIT状态等待 2MSL（四分钟）的时间呢？**

答：第一，为了保证客户机最后发送的那个ACK报文段能够到达服务器。这个ACK报文段可能会丢失。因而使处在LAST-ACK状态的 B 收不到对已发送的FIN＋ACK报文段的确认。服务器会超时重传这个FIN＋ACK报文段，而客户机就能在2MSL时间内收到这个重传的FIN+ACK报文段。接着客户机重传一次确认，重新启动2MSL计时器，最后客户机和服务器都可以进入到CLOSED（关闭）状态。如果没有2MSL等待时间，那么就无法收到重传的FIN+ ACK包，无法进入正常的CLOSED状态。

第二，防止“已失效的连接请求报文段”出现在本连接中。客户机在发送完最后一个ACK报文段，再经过时间2MSL，就可以使本连接持续的时间内所产生的报文段都从网络中消失。这样就可以使下一个新的连接中不会出现这种旧的连接请求报文段。

**3、三次握手为什么不能改成两次握手？**
答：三次握手中的每一次都是必须的。如果是两次握手，在第二次结束后，服务器并不能保证客户端已经收到了第二次的请求，如此一来的话，服务器会一直保存着这个通信过程，因为TCP通信都是要占用端口的，造成了一定的资源浪费。所以，就一定要让客户端来发送ACK的确认请求。

**4、关闭的时候为什么会是四次挥手？**
答：四次挥手不能像三次握手一样，三次握手可以将ACK+SYN 一起发送，ACK用于确认信息，SYN却是用来建立联机的；四次挥手中ACK是不能和FIN一起发送，ACK只是告诉客户端确认我收到了，等我将数据发送完毕之后会向其发送FIN的标志，所以四次挥手是不能够改变的。



## 3、TCP保证传输可靠性


